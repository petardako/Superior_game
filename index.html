<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPERIOR GAME - Cardano Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Inicializar Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDrbmaBOZAx2AL-NjrWm0tIGscea7YL-SM",
            authDomain: "superior-game-c6b8e.firebaseapp.com",
            databaseURL: "https://superior-game-c6b8e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "superior-game-c6b8e",
            storageBucket: "superior-game-c6b8e.firebasestorage.app",
            messagingSenderId: "878162337220",
            appId: "1:878162337220:web:cf6b18b7bf7e9ccc349891"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const { useState, useEffect } = React;

        const Gamepad2 = () => (
            <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/>
                <line x1="15" y1="13" x2="15.01" y2="13"/><line x1="18" y1="11" x2="18.01" y2="11"/>
                <rect x="2" y="6" width="20" height="12" rx="2"/>
            </svg>
        );

        const Trophy = () => (
            <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                <path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
            </svg>
        );

        const Heart = ({ filled }) => (
            <svg width="100%" height="100%" viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
        );

        const Zap = () => (
            <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
        );

        const Star = ({ filled }) => (
            <svg width="100%" height="100%" viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
        );

        const Users = () => (
            <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        );

        const SuperiorGame = () => {
            const [gameState, setGameState] = useState('loading');
            const [playerName, setPlayerName] = useState('');
            const [telegramUser, setTelegramUser] = useState(null);
            const [score, setScore] = useState(0);
            const [lives, setLives] = useState(3);
            const [level, setLevel] = useState(1);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [questionsInLevel, setQuestionsInLevel] = useState(0);
            const [streak, setStreak] = useState(0);
            const [startTime, setStartTime] = useState(null);
            const [leaderboard, setLeaderboard] = useState([]);
            const [totalScore, setTotalScore] = useState(0);
            const [levelQuestions, setLevelQuestions] = useState([]);
            const [responseTime, setResponseTime] = useState(0);
            const [usedQuestions, setUsedQuestions] = useState([]);

            const allQuestions = [
                { question: "What is Cardano?", options: ["A cryptocurrency", "A blockchain platform", "A wallet", "An exchange"], correct: 1, explanation: "Cardano is a third-generation blockchain platform designed for smart contracts and decentralized applications." },
                { question: "Who founded Cardano?", options: ["Vitalik Buterin", "Charles Hoskinson", "Gavin Wood", "Satoshi Nakamoto"], correct: 1, explanation: "Charles Hoskinson, co-founder of Ethereum, created Cardano with a scientific approach." },
                { question: "What consensus algorithm does Cardano use?", options: ["Proof of Work", "Proof of Stake", "Proof of Authority", "Delegated PoS"], correct: 1, explanation: "Cardano uses Ouroboros, a Proof of Stake protocol that's energy efficient." },
                { question: "What year was Cardano launched?", options: ["2015", "2017", "2019", "2021"], correct: 1, explanation: "Cardano was officially launched in September 2017." },
                { question: "How many layers does Cardano's architecture have?", options: ["1", "2", "3", "4"], correct: 1, explanation: "Cardano has CSL (Settlement Layer) and CCL (Computation Layer)." },
                { question: "What does CSL stand for?", options: ["Cardano Smart Layer", "Cardano Settlement Layer", "Cardano Security Layer", "Cardano System Layer"], correct: 1, explanation: "CSL handles ADA transactions and the ledger." },
                { question: "What does CCL stand for?", options: ["Cardano Computing Layer", "Cardano Computation Layer", "Cardano Contract Layer", "Cardano Code Layer"], correct: 1, explanation: "CCL is responsible for smart contracts and dApps." },
                { question: "What accounting model does Cardano use?", options: ["Account-based", "UTXO", "Balance-based", "Token-based"], correct: 1, explanation: "Cardano uses Extended UTXO (eUTXO) model for better security." },
                { question: "What makes Cardano's UTXO model unique?", options: ["It's faster", "It's extended (eUTXO)", "It's cheaper", "It's simpler"], correct: 1, explanation: "eUTXO adds smart contract capabilities to Bitcoin's UTXO model." },
                { question: "What programming language does Cardano use for smart contracts?", options: ["Solidity", "Rust", "Plutus", "JavaScript"], correct: 2, explanation: "Plutus is based on Haskell and designed for formal verification." },
                { question: "What update brought smart contracts to Cardano?", options: ["Shelley", "Alonzo", "Goguen", "Basho"], correct: 1, explanation: "The Alonzo hard fork in September 2021 enabled smart contracts." },
                { question: "What language is Plutus based on?", options: ["Python", "Java", "Haskell", "C++"], correct: 2, explanation: "Plutus is built on Haskell, a functional programming language." },
                { question: "What is Marlowe?", options: ["A wallet", "A language for financial contracts", "An exchange", "A token"], correct: 1, explanation: "Marlowe is a domain-specific language for financial smart contracts." },
                { question: "What's the advantage of functional programming for smart contracts?", options: ["It's faster", "Better formal verification", "Easier to learn", "More popular"], correct: 1, explanation: "Functional programming allows mathematical proof of correctness." },
                { question: "What is a Stake Pool?", options: ["A mining pool", "A validator node", "A wallet type", "A token"], correct: 1, explanation: "Stake Pools validate transactions and produce blocks on Cardano." },
                { question: "What is delegation in Cardano?", options: ["Sending ADA", "Assigning stake to a pool", "Creating a wallet", "Mining"], correct: 1, explanation: "Delegation allows ADA holders to participate in staking without running a node." },
                { question: "Do you lose control of your ADA when staking?", options: ["Yes, completely", "No, ADA stays in your wallet", "Only partially", "Depends on the pool"], correct: 1, explanation: "Your ADA never leaves your wallet when delegating to a stake pool." },
                { question: "What is an epoch in Cardano?", options: ["1 day", "5 days", "1 month", "1 year"], correct: 1, explanation: "An epoch is approximately 5 days (432,000 slots)." },
                { question: "What are staking rewards paid in?", options: ["Bitcoin", "Ethereum", "ADA", "USD"], correct: 2, explanation: "Staking rewards are paid in ADA from transaction fees and monetary expansion." },
                { question: "What is Project Catalyst?", options: ["A wallet", "A governance system", "A DEX", "A bridge"], correct: 1, explanation: "Project Catalyst is Cardano's decentralized governance and funding mechanism." },
                { question: "How do you vote in Catalyst?", options: ["With ADA holdings", "One person one vote", "Through stake pools", "By mining"], correct: 0, explanation: "Voting power in Catalyst is proportional to ADA holdings." },
                { question: "What are Catalyst proposals called?", options: ["Projects", "Ideas", "Proposals", "All of the above"], correct: 3, explanation: "They're commonly called proposals or projects seeking funding." },
                { question: "What does CIP stand for?", options: ["Cardano Implementation Proposal", "Cardano Improvement Proposal", "Cardano Innovation Protocol", "Cardano Investment Plan"], correct: 1, explanation: "CIPs are formal proposals for improving Cardano's protocol." },
                { question: "Who can submit a CIP?", options: ["Only developers", "Only IOHK", "Anyone in the community", "Only stake pool operators"], correct: 2, explanation: "CIPs are open to anyone in the Cardano community." },
                { question: "What was the Byron era about?", options: ["Foundation", "Decentralization", "Smart contracts", "Scaling"], correct: 0, explanation: "Byron established Cardano's foundation and basic functionality." },
                { question: "What did Shelley bring to Cardano?", options: ["Smart contracts", "Decentralization", "Scaling", "Governance"], correct: 1, explanation: "Shelley enabled decentralized block production through stake pools." },
                { question: "What is the Goguen era focused on?", options: ["Decentralization", "Smart contracts", "Scaling", "Interoperability"], correct: 1, explanation: "Goguen brought smart contract capabilities via Plutus and Marlowe." },
                { question: "What will Basho improve?", options: ["Security", "Decentralization", "Scaling and optimization", "Governance"], correct: 2, explanation: "Basho focuses on scaling through sidechains and optimization." },
                { question: "What is Voltaire about?", options: ["Smart contracts", "Scaling", "Governance and sustainability", "Interoperability"], correct: 2, explanation: "Voltaire will complete Cardano's self-governing system." },
                { question: "What is Hydra?", options: ["A wallet", "A layer 2 scaling solution", "A staking protocol", "A DEX"], correct: 1, explanation: "Hydra is Cardano's layer 2 protocol for massive scalability." },
                { question: "What is Mithril?", options: ["A token", "A stake-based signature scheme", "A wallet", "A DEX"], correct: 1, explanation: "Mithril enables fast bootstrapping and light clients." },
                { question: "What are Native Assets?", options: ["Tokens requiring smart contracts", "First-class tokens on Cardano", "NFTs only", "Stablecoins"], correct: 1, explanation: "Native Assets are treated like ADA at the protocol level." },
                { question: "Do Native Assets require smart contracts?", options: ["Yes, always", "No, they're built-in", "Only for complex tokens", "Depends on the type"], correct: 1, explanation: "Native Assets are handled by the ledger itself, no smart contracts needed." },
                { question: "What is a Cardano sidechain?", options: ["A layer 2 solution", "A separate blockchain", "Both A and B", "A wallet type"], correct: 2, explanation: "Sidechains are independent blockchains connected to Cardano's mainchain." },
                { question: "Which three organizations develop Cardano?", options: ["IOG, CF, Emurgo", "IOHK, Binance, Coinbase", "IOG, Ethereum, Polkadot", "Only IOHK"], correct: 0, explanation: "Input Output (IOG), Cardano Foundation, and Emurgo collaborate on development." },
                { question: "What is IOG's role?", options: ["Marketing only", "Research and development", "Only funding", "Running stake pools"], correct: 1, explanation: "IOG (formerly IOHK) handles research, development, and engineering." },
                { question: "What does the Cardano Foundation do?", options: ["Development", "Adoption and standards", "Mining", "Trading"], correct: 1, explanation: "The Foundation oversees ecosystem development and adoption." },
                { question: "What is Emurgo's focus?", options: ["Research", "Commercial adoption", "Governance", "Mining"], correct: 1, explanation: "Emurgo focuses on commercial ventures and enterprise adoption." },
                { question: "Is Cardano development centralized?", options: ["Yes, only IOHK", "No, multiple organizations", "Yes, fully centralized", "No governance exists"], correct: 1, explanation: "Three entities plus community governance ensure decentralization." },
                { question: "What is Ouroboros Praos?", options: ["A wallet", "An improved consensus protocol", "A DEX", "A token"], correct: 1, explanation: "Praos is an enhanced version of Ouroboros with better security." },
                { question: "What does 'peer-reviewed' mean for Cardano?", options: ["Fast development", "Academic scrutiny", "Community voting", "No testing needed"], correct: 1, explanation: "Cardano's research undergoes academic peer review before implementation." },
                { question: "What is the maximum supply of ADA?", options: ["21 million", "45 billion", "100 billion", "Unlimited"], correct: 1, explanation: "Cardano has a maximum supply of 45 billion ADA tokens." },
                { question: "What is the ticker symbol for Cardano?", options: ["BTC", "ETH", "ADA", "DOT"], correct: 2, explanation: "ADA is the native cryptocurrency of the Cardano blockchain." },
                { question: "What makes Cardano environmentally friendly?", options: ["Uses solar power", "Proof of Stake consensus", "Cloud mining", "No transactions"], correct: 1, explanation: "Cardano's Proof of Stake uses significantly less energy than Proof of Work." },
                { question: "What is a Cardano wallet?", options: ["A physical wallet", "Software to store ADA", "A mining device", "An exchange"], correct: 1, explanation: "A Cardano wallet is software that allows you to store, send, and receive ADA." },
                { question: "Which wallet is official for Cardano?", options: ["MetaMask", "Daedalus", "Trust Wallet", "Exodus"], correct: 1, explanation: "Daedalus is the official full-node wallet developed by IOG." },
                { question: "What is Yoroi?", options: ["A DEX", "A light wallet", "A stake pool", "A token"], correct: 1, explanation: "Yoroi is a light wallet for Cardano developed by Emurgo." },
                { question: "What is minimum ADA for staking?", options: ["1 ADA", "10 ADA", "100 ADA", "No minimum"], correct: 3, explanation: "There's no minimum ADA required to start staking on Cardano." },
                { question: "How often are staking rewards distributed?", options: ["Daily", "Every epoch (~5 days)", "Monthly", "Yearly"], correct: 1, explanation: "Staking rewards are distributed at the end of each epoch, approximately every 5 days." },
                { question: "Which meme coins help grow the Cardano ecosystem?", options: ["$SNEK üêç", "$HOSKY üê∫", "$SUPERIOR ‚ö°", "All of them üêçüê∫‚ö°"], correct: 3, explanation: "All these meme coins contribute to growing the Cardano ecosystem! Each brings unique value and community engagement to ADA." },
                { question: "What is a smart contract?", options: ["A legal document", "Self-executing code", "A wallet type", "A mining algorithm"], correct: 1, explanation: "Smart contracts are self-executing programs that run on the blockchain." },
                { question: "What are dApps?", options: ["Mobile apps", "Decentralized applications", "Download apps", "Developer apps"], correct: 1, explanation: "dApps are decentralized applications that run on blockchain technology." }
            ];

            // Fisher-Yates shuffle
            const shuffleArray = (arr) => {
                const array = [...arr];
                let currentIndex = array.length;
                while (currentIndex != 0) {
                    let randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            };

            // Shuffle question options
            const shuffleQuestionOptions = (question) => {
                const indices = [0, 1, 2, 3];
                const shuffledIndices = shuffleArray(indices);
                
                return {
                    ...question,
                    options: shuffledIndices.map(i => question.options[i]),
                    correct: shuffledIndices.indexOf(question.correct)
                };
            };

            useEffect(() => {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    const user = tg.initDataUnsafe?.user;
                    if (user) {
                        const username = user.username || `${user.first_name || 'User'}${user.last_name ? ' ' + user.last_name : ''}`;
                        setPlayerName(username);
                        setTelegramUser(user);
                        
                        // Verificar si hay progreso guardado y mostrar directamente pantalla de continuar
                        loadGameProgress((progress) => {
                            if (progress && progress.lives > 0) {
                                // Cargar los datos del progreso en los estados
                                setScore(progress.score || 0);
                                setTotalScore(progress.totalScore || 0);
                                setLives(progress.lives || 3);
                                setLevel(progress.level || 1);
                                setCurrentQuestion(progress.currentQuestion || 0);
                                setQuestionsInLevel(progress.questionsInLevel || 0);
                                setStreak(progress.streak || 0);
                                
                                // Ir directamente a pantalla de continuar
                                setGameState('continue');
                            } else {
                                // No hay progreso, mostrar men√∫ normal
                                setGameState('menu');
                            }
                        });
                    } else {
                        setPlayerName('Player');
                        setGameState('menu');
                    }
                } else {
                    setPlayerName('Player');
                    setGameState('menu');
                }
                
                loadLeaderboard();
            }, []);

            const loadLeaderboard = () => {
                try {
                    // Cargar desde Firebase Realtime Database
                    const leaderboardRef = database.ref('leaderboard');
                    
                    leaderboardRef.orderByChild('totalScore').limitToLast(10).once('value', (snapshot) => {
                        const players = [];
                        snapshot.forEach((childSnapshot) => {
                            players.push(childSnapshot.val());
                        });
                        
                        // Ordenar de mayor a menor puntuaci√≥n
                        players.sort((a, b) => b.totalScore - a.totalScore);
                        setLeaderboard(players);
                    });
                } catch (error) {
                    console.error('Error loading leaderboard from Firebase:', error);
                    setLeaderboard([]);
                }
            };

            const savePlayerScore = (name, score, level) => {
                try {
                    const userId = telegramUser?.id || `user_${name.toLowerCase().replace(/\s/g, '_')}`;
                    const playerRef = database.ref('leaderboard/' + userId);
                    
                    // Primero verificar si el jugador ya existe
                    playerRef.once('value', (snapshot) => {
                        const existingData = snapshot.val();
                        
                        let playerData = {
                            id: userId,
                            name: name,
                            totalScore: score,
                            maxLevel: level,
                            gamesPlayed: 1,
                            lastPlayed: Date.now()
                        };
                        
                        if (existingData) {
                            // Solo actualizar si es un nuevo r√©cord
                            playerData = {
                                id: userId,
                                name: name,
                                totalScore: Math.max(existingData.totalScore, score),
                                maxLevel: Math.max(existingData.maxLevel, level),
                                gamesPlayed: existingData.gamesPlayed + 1,
                                lastPlayed: Date.now()
                            };
                        }
                        
                        // Guardar en Firebase
                        playerRef.set(playerData, (error) => {
                            if (error) {
                                console.error('Error saving to Firebase:', error);
                            } else {
                                console.log('‚úÖ Score saved to Firebase successfully!');
                                loadLeaderboard();
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error in savePlayerScore:', error);
                }
            };

            // Nueva funci√≥n para cargar progreso guardado
            const loadGameProgress = (callback) => {
                try {
                    const userId = telegramUser?.id || `user_${playerName.toLowerCase().replace(/\s/g, '_')}`;
                    const progressRef = database.ref('progress/' + userId);
                    
                    progressRef.once('value', (snapshot) => {
                        const progress = snapshot.val();
                        
                        if (progress) {
                            // Verificar si el progreso es reciente (menos de 24 horas)
                            const twentyFourHours = 24 * 60 * 60 * 1000;
                            if (Date.now() - progress.savedAt < twentyFourHours) {
                                callback(progress);
                            } else {
                                // Progreso muy antiguo, eliminarlo
                                progressRef.remove();
                                callback(null);
                            }
                        } else {
                            callback(null);
                        }
                    });
                } catch (error) {
                    console.error('Error loading progress:', error);
                    callback(null);
                }
            };

            // Nueva funci√≥n para eliminar progreso guardado
            const clearGameProgress = () => {
                try {
                    const userId = telegramUser?.id || `user_${playerName.toLowerCase().replace(/\s/g, '_')}`;
                    const progressRef = database.ref('progress/' + userId);
                    progressRef.remove();
                    console.log('üóëÔ∏è Game progress cleared!');
                } catch (error) {
                    console.error('Error clearing progress:', error);
                }
            };

            const startGame = () => {
                // Empezar juego nuevo directamente
                startNewGame();
            };

            const startNewGame = () => {
                // Limpiar cualquier progreso anterior
                clearGameProgress();
                
                // Mezclar todas las preguntas
                const shuffled = shuffleArray(allQuestions);
                
                // Encontrar la pregunta de meme coins
                const memeQuestion = shuffled.find(q => q.question.includes("Which meme coins help grow"));
                
                // Filtrar para eliminar la pregunta de meme coins del array mezclado
                const questionsWithoutMeme = shuffled.filter(q => q.question !== memeQuestion?.question);
                
                // Con 95% de probabilidad, insertar la pregunta de meme coins en las primeras 10 preguntas
                let finalQuestions = [...questionsWithoutMeme];
                if (memeQuestion && Math.random() < 0.95) {
                    // Insertar en una posici√≥n aleatoria entre 0 y 9 (primeras 10 preguntas)
                    const insertPosition = Math.floor(Math.random() * 10);
                    finalQuestions.splice(insertPosition, 0, memeQuestion);
                }
                
                // Mezclar las opciones de cada pregunta
                const gameQuestions = finalQuestions.map(q => shuffleQuestionOptions(q));
                
                // Tomar las primeras 50 para el juego completo (10 niveles x 5 preguntas)
                const questions = gameQuestions.slice(0, 50);
                setLevelQuestions(questions.slice(0, 5));
                setUsedQuestions(questions);
                setGameState('playing');
                setScore(0);
                setLives(3);
                setLevel(1);
                setCurrentQuestion(0);
                setQuestionsInLevel(0);
                setStreak(0);
                setStartTime(Date.now());
                setTotalScore(0);
                setResponseTime(0);
            };

            const continueGame = () => {
                loadGameProgress((progress) => {
                    if (progress) {
                        // Cargar todos los estados del progreso guardado
                        setUsedQuestions(progress.usedQuestions || []);
                        setLevelQuestions(progress.levelQuestions || []);
                        setScore(progress.score || 0);
                        setTotalScore(progress.totalScore || 0);
                        setLives(progress.lives || 3);
                        setLevel(progress.level || 1);
                        setCurrentQuestion(progress.currentQuestion || 0);
                        setQuestionsInLevel(progress.questionsInLevel || 0);
                        setStreak(progress.streak || 0);
                        setResponseTime(0);
                        setStartTime(Date.now());
                        setGameState('playing');
                        console.log('üéÆ Game continued from saved progress!');
                    } else {
                        startNewGame();
                    }
                });
            };

            const handleAnswer = (selectedIndex) => {
                const timeElapsed = (Date.now() - startTime) / 1000;
                setResponseTime(timeElapsed);
                const correct = levelQuestions[currentQuestion].correct === selectedIndex;
                
                if (correct) {
                    let points = 100;
                    let speedBonus = 0;
                    if (timeElapsed < 3) speedBonus = 100;
                    else if (timeElapsed < 5) speedBonus = 50;
                    else if (timeElapsed < 10) speedBonus = 25;
                    
                    points += speedBonus;
                    points += streak * 10;
                    points = Math.floor(points * (1 + (level - 1) * 0.1));
                    
                    setScore(score + points);
                    setTotalScore(totalScore + points);
                    setStreak(streak + 1);
                    setGameState('correct');
                    
                    // NO guardar aqu√≠ - esperamos a nextQuestion
                } else {
                    setLives(lives - 1);
                    setStreak(0);
                    setGameState('incorrect');
                    
                    if (lives - 1 === 0) {
                        setTimeout(() => {
                            // Limpiar progreso guardado cuando pierdes
                            clearGameProgress();
                            savePlayerScore(playerName, totalScore, level);
                            setGameState('gameover');
                        }, 2000);
                        return;
                    }
                    // NO guardar aqu√≠ tampoco
                }
            };

            const nextQuestion = () => {
                const newQuestionsInLevel = questionsInLevel + 1;
                
                if (newQuestionsInLevel >= 5) {
                    setQuestionsInLevel(0);
                    if (level < 10) {
                        setGameState('levelup');
                    } else {
                        // Juego completado, limpiar progreso
                        clearGameProgress();
                        savePlayerScore(playerName, totalScore, 10);
                        setGameState('victory');
                    }
                } else {
                    // Calcular los nuevos valores
                    const newQuestionIndex = currentQuestion + 1;
                    
                    // Actualizar estados
                    setQuestionsInLevel(newQuestionsInLevel);
                    setCurrentQuestion(newQuestionIndex);
                    setStartTime(Date.now());
                    setResponseTime(0);
                    setGameState('playing');
                    
                    // Guardar EXPL√çCITAMENTE con los nuevos valores calculados
                    setTimeout(() => {
                        const userId = telegramUser?.id || `user_${playerName.toLowerCase().replace(/\s/g, '_')}`;
                        const progressRef = database.ref('progress/' + userId);
                        
                        progressRef.set({
                            userId: userId,
                            playerName: playerName,
                            score: score,
                            lives: lives,
                            level: level,
                            currentQuestion: newQuestionIndex, // Valor ya calculado
                            questionsInLevel: newQuestionsInLevel, // Valor ya calculado
                            streak: streak,
                            totalScore: totalScore,
                            savedAt: Date.now(),
                            usedQuestions: usedQuestions,
                            levelQuestions: levelQuestions
                        });
                        console.log('üíæ Question saved:', newQuestionIndex, '| Total:', totalScore, '| Lives:', lives);
                    }, 200);
                }
            };

            const goToNextLevel = () => {
                const newLevel = level + 1;
                // Tomar las siguientes 5 preguntas de las ya mezcladas
                const startIdx = (newLevel - 1) * 5;
                const questions = usedQuestions.slice(startIdx, startIdx + 5);
                
                setLevelQuestions(questions);
                setLevel(newLevel);
                setCurrentQuestion(0);
                setStartTime(Date.now());
                setResponseTime(0);
                setGameState('playing');
                
                // Guardar EXPL√çCITAMENTE con los nuevos valores
                setTimeout(() => {
                    saveGameProgress({
                        level: newLevel,
                        currentQuestion: 0,
                        questionsInLevel: 0,
                        levelQuestions: questions
                    });
                }, 100);
            };

            const renderMenu = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-6">
                            <img src="https://i.imgur.com/W0XeBvj.png" alt="Logo" className="w-20 h-20 mx-auto rounded-full mb-4 object-cover" />
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">SUPERIOR GAME</h1>
                            <p className="text-gray-600">Master Cardano - 10 Levels Challenge</p>
                            {playerName && (
                                <p className="text-sm text-blue-600 mt-2">üëã Welcome, @{playerName}!</p>
                            )}
                        </div>

                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div className="text-center flex-1">
                                    <div className="text-3xl font-bold text-blue-600">10</div>
                                    <div className="text-xs text-gray-600">Levels</div>
                                </div>
                                <div className="text-center flex-1">
                                    <div className="text-3xl font-bold text-cyan-600">50</div>
                                    <div className="text-xs text-gray-600">Questions</div>
                                </div>
                                <div className="text-center flex-1">
                                    <div className="w-8 h-8 mx-auto text-blue-500"><Heart filled={true} /></div>
                                    <div className="text-xs text-gray-600">3 Lives</div>
                                </div>
                            </div>
                            <div className="text-center text-sm text-gray-700">
                                <span className="font-bold text-blue-600">Cardano is SUPERIOR!</span>
                            </div>
                        </div>

                        <button
                            onClick={startGame}
                            className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-cyan-700 transition-all transform hover:scale-105 shadow-lg mb-4"
                        >
                            Start Challenge!
                        </button>

                        <button
                            onClick={() => setGameState('leaderboard')}
                            className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white py-3 rounded-xl font-bold hover:from-yellow-600 hover:to-yellow-700 transition-all flex items-center justify-center gap-2"
                        >
                            <div className="w-5 h-5"><Users /></div>
                            Global Leaderboard
                        </button>
                    </div>
                </div>
            );

            const renderContinue = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <img src="https://i.imgur.com/W0XeBvj.png" alt="Logo" className="w-20 h-20 mx-auto rounded-full mb-4 object-cover" />
                        
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">Continue Game? üéÆ</h2>
                        <p className="text-gray-600 mb-6">You have a saved game in progress!</p>
                        
                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 mb-6">
                            <div className="grid grid-cols-3 gap-4 mb-4">
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-blue-600">Level {level}</div>
                                    <div className="text-xs text-gray-600">Current Level</div>
                                </div>
                                <div className="text-center">
                                    <div className="flex gap-1 justify-center mb-1">
                                        {[...Array(3)].map((_, i) => (
                                            <div key={i} className={`w-6 h-6 ${i < lives ? 'text-blue-500' : 'text-gray-300'}`}>
                                                <Heart filled={i < lives} />
                                            </div>
                                        ))}
                                    </div>
                                    <div className="text-xs text-gray-600">{lives} Lives</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-blue-600">{totalScore}</div>
                                    <div className="text-xs text-gray-600">Points</div>
                                </div>
                            </div>
                            <div className="text-sm text-gray-700">
                                Progress: Question {questionsInLevel + 1}/5
                            </div>
                        </div>

                        <button
                            onClick={continueGame}
                            className="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 shadow-lg mb-3"
                        >
                            ‚ñ∂Ô∏è Continue Game
                        </button>

                        <button
                            onClick={startNewGame}
                            className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-3 rounded-xl font-bold hover:from-blue-700 hover:to-cyan-700 transition-all mb-3"
                        >
                            üîÑ Start New Game
                        </button>

                        <button
                            onClick={() => setGameState('menu')}
                            className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300 transition-all"
                        >
                            ‚Üê Back to Menu
                        </button>
                    </div>
                </div>
            );

            const renderPlaying = () => {
                if (!levelQuestions || levelQuestions.length === 0 || !levelQuestions[currentQuestion]) {
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl shadow-2xl p-8 text-center">
                                <p className="text-gray-600">Loading...</p>
                            </div>
                        </div>
                    );
                }

                const q = levelQuestions[currentQuestion];

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex gap-2">
                                    {[...Array(3)].map((_, i) => (
                                        <div key={i} className={`w-8 h-8 ${i < lives ? 'text-blue-500' : 'text-gray-300'}`}>
                                            <Heart filled={i < lives} />
                                        </div>
                                    ))}
                                </div>
                                <div className="text-center">
                                    <p className="text-sm font-bold text-blue-600">Cardano is SUPERIOR!</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-2xl font-bold text-blue-600">{score}</p>
                                    <p className="text-xs text-gray-500">points</p>
                                </div>
                            </div>

                            <div className="flex items-center justify-between mb-6">
                                <div className="flex gap-1">
                                    {[...Array(level)].map((_, i) => (
                                        <div key={i} className="w-5 h-5 text-yellow-500"><Star filled={true} /></div>
                                    ))}
                                    {[...Array(10 - level)].map((_, i) => (
                                        <div key={i} className="w-5 h-5 text-gray-300"><Star filled={false} /></div>
                                    ))}
                                </div>
                                <span className="text-sm font-semibold text-gray-600">Level {level}/10</span>
                            </div>

                            {streak > 0 && (
                                <div className="bg-gradient-to-r from-yellow-400 to-yellow-500 text-white px-4 py-2 rounded-lg mb-4 text-center flex items-center justify-center gap-2">
                                    <div className="w-4 h-4"><Zap /></div>
                                    <span className="font-bold">Streak x{streak}!</span>
                                </div>
                            )}

                            <div className="mb-6">
                                <span className="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-semibold">
                                    Question {questionsInLevel + 1}/5
                                </span>
                            </div>

                            <h2 className="text-2xl font-bold text-gray-800 mb-6">{q.question}</h2>

                            <div className="space-y-3">
                                {q.options.map((option, index) => (
                                    <button
                                        key={index}
                                        onClick={() => handleAnswer(index)}
                                        className="w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all font-medium text-gray-700"
                                    >
                                        <span className="inline-block w-8 h-8 rounded-full bg-blue-100 text-blue-600 text-center leading-8 mr-3 font-bold">
                                            {String.fromCharCode(65 + index)}
                                        </span>
                                        {option}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const renderFeedback = (isCorrect) => {
                if (!levelQuestions || !levelQuestions[currentQuestion]) return null;
                const q = levelQuestions[currentQuestion];
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full text-center">
                            <div className={`w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 ${
                                isCorrect ? 'bg-green-100' : 'bg-red-100'
                            }`}>
                                {isCorrect ? (
                                    <div className="w-12 h-12 text-green-600"><Trophy /></div>
                                ) : (
                                    <span className="text-4xl">‚úó</span>
                                )}
                            </div>

                            <h2 className={`text-3xl font-bold mb-4 ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>
                                {isCorrect ? 'Correct!' : 'Incorrect'}
                            </h2>

                            {isCorrect && responseTime > 0 && (
                                <p className="text-blue-600 font-semibold mb-4">
                                    Answered in {responseTime.toFixed(1)}s
                                    {responseTime < 3 && ' - Lightning fast! ‚ö°+100 bonus'}
                                    {responseTime >= 3 && responseTime < 5 && ' - Quick! ‚ö°+50 bonus'}
                                    {responseTime >= 5 && responseTime < 10 && ' - Good speed! ‚ö°+25 bonus'}
                                </p>
                            )}

                            <div className="bg-blue-50 rounded-xl p-6 mb-6 text-left">
                                <p className="text-sm text-gray-600 mb-2">üìö Explanation:</p>
                                <p className="text-gray-800">{q.explanation}</p>
                            </div>

                            <button
                                onClick={nextQuestion}
                                className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-8 py-3 rounded-xl font-bold hover:from-blue-700 hover:to-cyan-700 transition-all"
                            >
                                Next Question ‚Üí
                            </button>
                        </div>
                    </div>
                );
            };

            const renderLevelUp = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div className="w-24 h-24 mx-auto mb-6 animate-bounce">
                            <div className="text-yellow-500"><Trophy /></div>
                        </div>
                        
                        <h2 className="text-4xl font-bold text-gray-800 mb-4">Level {level} Complete! üéâ</h2>
                        
                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 mb-6">
                            <p className="text-5xl font-bold text-blue-600 mb-2">{score}</p>
                            <p className="text-gray-600 mb-4">Level Score</p>
                            
                            <div className="flex gap-1 justify-center mb-4">
                                {[...Array(level)].map((_, i) => (
                                    <div key={i} className="w-6 h-6 text-yellow-500"><Star filled={true} /></div>
                                ))}
                            </div>
                            
                            {level < 10 && (
                                <p className="text-gray-700 font-semibold">
                                    Ready for Level {level + 1}? üöÄ
                                </p>
                            )}
                        </div>

                        <button
                            onClick={goToNextLevel}
                            className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-cyan-700 transition-all transform hover:scale-105 shadow-lg"
                        >
                            Continue to Level {level + 1}!
                        </button>
                    </div>
                </div>
            );

            const renderGameOver = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <h2 className="text-4xl font-bold text-gray-800 mb-4">Game Over</h2>
                        <p className="text-gray-600 mb-2">Great effort, @{playerName}!</p>
                        <p className="text-gray-600 mb-6">You reached Level {level}</p>
                        
                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 mb-6">
                            <p className="text-5xl font-bold text-blue-600 mb-2">{totalScore}</p>
                            <p className="text-gray-600 mb-3">Total Points</p>
                            
                            <div className="flex gap-1 justify-center">
                                {[...Array(level)].map((_, i) => (
                                    <div key={i} className="w-6 h-6 text-yellow-500"><Star filled={true} /></div>
                                ))}
                                {[...Array(10 - level)].map((_, i) => (
                                    <div key={i} className="w-6 h-6 text-gray-300"><Star filled={false} /></div>
                                ))}
                            </div>
                        </div>

                        <button
                            onClick={() => setGameState('leaderboard')}
                            className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white py-3 rounded-xl font-bold mb-3 hover:from-yellow-600 hover:to-yellow-700 transition-all flex items-center justify-center gap-2"
                        >
                            <div className="w-5 h-5"><Users /></div>
                            View Leaderboard
                        </button>

                        <button
                            onClick={() => setGameState('menu')}
                            className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-3 rounded-xl font-bold hover:from-blue-700 hover:to-cyan-700 transition-all"
                        >
                            Play Again
                        </button>
                    </div>
                </div>
            );

            const renderVictory = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div className="w-32 h-32 mx-auto text-yellow-500 mb-6 animate-pulse"><Trophy /></div>
                        <h2 className="text-5xl font-bold text-gray-800 mb-4">CHAMPION! üëë</h2>
                        <p className="text-xl text-gray-700 mb-2">Congratulations, @{playerName}!</p>
                        <p className="text-gray-600 mb-6">You completed all 10 levels!</p>
                        
                        <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-xl p-6 mb-6">
                            <p className="text-6xl font-bold text-blue-600 mb-3">{totalScore}</p>
                            <p className="text-gray-600 mb-4">Total Score</p>
                            
                            <div className="flex gap-1 justify-center mb-4">
                                {[...Array(10)].map((_, i) => (
                                    <div key={i} className="w-6 h-6 text-yellow-500"><Star filled={true} /></div>
                                ))}
                            </div>
                            
                            <p className="text-lg font-bold text-gray-800">üéì Cardano Master!</p>
                        </div>

                        <button
                            onClick={() => setGameState('leaderboard')}
                            className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white py-4 rounded-xl font-bold mb-3 hover:from-yellow-600 hover:to-yellow-700 transition-all flex items-center justify-center gap-2"
                        >
                            <div className="w-5 h-5"><Users /></div>
                            View Leaderboard
                        </button>

                        <button
                            onClick={() => setGameState('menu')}
                            className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-xl font-bold hover:from-blue-700 hover:to-cyan-700 transition-all"
                        >
                            Play Again
                        </button>
                    </div>
                </div>
            );

            const renderLeaderboard = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 mx-auto text-yellow-500 mb-4"><Trophy /></div>
                            <h2 className="text-3xl font-bold text-gray-800">Global Leaderboard</h2>
                            <p className="text-gray-600 text-sm">Top Cardano Masters</p>
                        </div>

                        <div className="space-y-3 mb-6 max-h-96 overflow-y-auto">
                            {leaderboard.length === 0 ? (
                                <div className="text-center text-gray-500 py-8">
                                    <p>No players yet!</p>
                                    <p className="text-sm">Be the first to play!</p>
                                </div>
                            ) : (
                                leaderboard.map((player, index) => (
                                    <div key={index} className={`flex items-center justify-between p-4 rounded-xl ${
                                        index === 0 ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 border-2 border-yellow-400' :
                                        index === 1 ? 'bg-gradient-to-r from-gray-100 to-gray-200 border-2 border-gray-400' :
                                        index === 2 ? 'bg-gradient-to-r from-yellow-50 to-yellow-100 border-2 border-yellow-300' :
                                        'bg-gray-50'
                                    }`}>
                                        <div className="flex items-center gap-3">
                                            <span className={`text-2xl font-bold ${
                                                index === 0 ? 'text-yellow-600' :
                                                index === 1 ? 'text-gray-600' :
                                                index === 2 ? 'text-yellow-700' :
                                                'text-gray-400'
                                            }`}>
                                                {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                                            </span>
                                            <div>
                                                <p className="font-bold text-gray-800">@{player.name}</p>
                                                <p className="text-xs text-gray-500">
                                                    Level {player.maxLevel} ‚Ä¢ {player.gamesPlayed} games
                                                </p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-xl font-bold text-blue-600">{player.totalScore}</p>
                                            <div className="flex gap-0.5 justify-end">
                                                {[...Array(Math.min(player.maxLevel, 5))].map((_, i) => (
                                                    <div key={i} className="w-3 h-3 text-yellow-500"><Star filled={true} /></div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        <button
                            onClick={() => setGameState('menu')}
                            className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-3 rounded-xl font-bold hover:from-blue-700 hover:to-cyan-700 transition-all"
                        >
                            Back to Menu
                        </button>
                    </div>
                </div>
            );

            return (
                <>
                    {gameState === 'loading' && (
                        <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-cyan-600 flex items-center justify-center">
                            <div className="text-white text-xl">Loading...</div>
                        </div>
                    )}
                    {gameState === 'menu' && renderMenu()}
                    {gameState === 'continue' && renderContinue()}
                    {gameState === 'playing' && renderPlaying()}
                    {gameState === 'correct' && renderFeedback(true)}
                    {gameState === 'incorrect' && renderFeedback(false)}
                    {gameState === 'levelup' && renderLevelUp()}
                    {gameState === 'gameover' && renderGameOver()}
                    {gameState === 'victory' && renderVictory()}
                    {gameState === 'leaderboard' && renderLeaderboard()}
                </>
            );
        };

        ReactDOM.render(<SuperiorGame />, document.getElementById('root'));
    </script>
</body>
</html>